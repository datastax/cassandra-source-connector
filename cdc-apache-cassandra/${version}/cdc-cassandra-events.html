<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CDC for Cassandra Events :: DataStax CDC for Apache Cassandra documentation</title>
    <link rel="canonical" href="http://docs.datastax.com/en/cdc-for-cassandra/cdc-apache-cassandra/${version}/cdc-cassandra-events.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../assets/css/site.css">
    <link rel="icon" href="https://www.datastax.com/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a href="http://docs.datastax.com/en/cdc-for-cassandra">
        <img width="223px" height="43px" src="../../assets/img/logo.svg"/>
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-end__group">
          <div class="navbar-item">
            <form id="alg-search-form" class="ds-search-form" action="https://www.datastax.com/search" target="_blank" method="GET">
                <div>
                    <input id="alg-search-input" class="ds-datastax-search-input" type="text" name="query" placeholder="Search docs"/>
                    <button id="alg-search-button" class="ds-search-button" type="submit" style="display: none"></button>
                    <input id="dataset" type="hidden" name="dataset" value="docs"/>
                </div>
            </form>
          </div>
          <div class="navbar-item">
             <a class="navbar-item" href="/en/landing_page/doc/landing_page/current.html">Docs</a>
          </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="cdc-apache-cassandra" data-version="${version}">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">DataStax CDC for Apache Cassandra(R) Documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item toggler" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">About CDC for Cassandra</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="install.html">Installing CDC for Cassandra</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="monitor.html">Monitor CDC for Cassandra</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="faqs.html">CDC for Cassandra FAQs</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">DataStax CDC for Apache Cassandra(R) Documentation</span>
    <span class="version">${version}</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">DataStax CDC for Apache Cassandra(R) Documentation</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">${version}</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">DataStax CDC for Apache Cassandra(R) Documentation</a></li>
    <li><a href="cdc-cassandra-events.html">CDC for Cassandra Events</a></li>
  </ul>
</nav>
  <!--<div class="edit-this-page"><a href="https://github.com/datastax/cdc-for-cassandra/blob/master/docs/docs/modules/ROOT/pages/cdc-cassandra-events.adoc">Edit this Page</a></div>-->
</div>
  <div class="content">
<article class="doc">
<h1 class="page">CDC for Cassandra Events</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The DataStax CDC for Cassandra agent pushes the mutation primary key for the CDC-enabled table into the Apache Pulsar events topic (also called the dirty topic). The messages in the data topic (or clean topic) are keyed messages where both the key and the payload are <a href="https://avro.apache.org/docs/current/spec.html#schema_record">AVRO records</a>:
* The message key is an AVRO record including all the primary key columns of your Cassandra table.
* The message payload is an AVRO record including regular columns from your Cassandra table.</p>
</div>
<div class="paragraph">
<p>In order to support <a href="https://pulsar.apache.org/docs/en/concepts-topic-compaction/">Pulsar Topic Compaction</a>, the message key is encoded separately from the message payload, in the message metadata.</p>
</div>
<div class="paragraph">
<p>Finally, the following CQL data types are encoded as AVRO logical types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Date</code></p>
</li>
<li>
<p><code>Decimal</code></p>
</li>
<li>
<p><code>Duration</code></p>
</li>
<li>
<p><code>Timestamp</code></p>
</li>
<li>
<p><code>Varint</code></p>
</li>
<li>
<p><code>Uuid</code>, <code>timeuuid</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See <a href="https://avro.apache.org/docs/current/spec.html#Logical+Types">AVRO Logical Types</a> for more info on AVRO.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_change_events_key"><a class="anchor" href="#_change_events_key"></a>Change Event’s Key</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For a given table, the change event’s key is an AVRO record that contains a field for each column in the primary key of the table at the time the event was created. Both the events and the data topics (also called the dirty and the clean topics) have the same message key, an AVRO record including the primary key columns.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_insert_event"><a class="anchor" href="#_insert_event"></a><code>INSERT</code> Event</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s create a Cassandra table to illustrate what happens:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE KEYSPACE ks1 WITH replication = {'class': 'NetworkTopologyStrategy', 'us-east1': '3'}  AND durable_writes = true;

CREATE TABLE ks1.tbl1 (
    key text PRIMARY KEY,
    c1 text
) WITH additional_write_policy = '99PERCENTILE'
    AND bloom_filter_fp_chance = 0.01
    AND caching = {'keys': 'ALL', 'rows_per_partition': 'NONE'}
    AND comment = ''
    AND compaction = {'class': 'org.apache.cassandra.db.compaction.UnifiedCompactionStrategy'}
    AND compression = {'chunk_length_in_kb': '64', 'class': 'org.apache.cassandra.io.compress.LZ4Compressor'}
    AND crc_check_chance = 1.0
    AND default_time_to_live = 0
    AND gc_grace_seconds = 864000
    AND max_index_interval = 2048
    AND memtable_flush_period_in_ms = 0
    AND min_index_interval = 128
    AND read_repair = 'BLOCKING'
    AND speculative_retry = '99PERCENTILE';</pre>
</div>
</div>
<div class="paragraph">
<p>Then insert a row:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>INSERT INTO ks1.tbl1 (key, c1) VALUES (`3`, `bob3`)</pre>
</div>
</div>
<div class="paragraph">
<p>When an <code>INSERT</code> statement is executed, the CDC agent catches the mutation from the commitlog files and sends a message into the dirty topic. The deployed source connector then reads the full row from the Cassandra datacenter, and publishes a message into the clean topic with all regular columns encoded as an AVRO record in the message payload.</p>
</div>
<div class="paragraph">
<p>Here is a JSON representation of the AVRO Record for the message key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
  "key": "3"
}</pre>
</div>
</div>
<div class="paragraph">
<p>And a JSON representation of the AVRO Record for the message payload:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
  "c1": "bob3"
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_delete_event"><a class="anchor" href="#_delete_event"></a><code>DELETE</code> Event</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When deleting a row, the Cassandra source connector will publish a tombstone message into the clean topic with a message key matching the C* primary key and a null payload. The null payload acts as a message tombstone, and the downstream Pulsar connectors like the Elasticsearch sink should delete the corresponding row (or document in the case of Elasticsearch).</p>
</div>
<div class="sect2">
<h3 id="_check_source_connector_status"><a class="anchor" href="#_check_source_connector_status"></a>Check Source Connector status</h3>
<div class="paragraph">
<p>You can check the connector status with the following command. The connector must be running.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bin/pulsar-admin source status --name cassandra-source-ks1-table1
{
    "numInstances" : 1,
    "numRunning" : 1,
    "instances" : [ {
        "instanceId" : 0,
        "status" : {
        "running" : true,
        "error" : "",
        "numRestarts" : 0,
        "numReceivedFromSource" : 0,
        "numSystemExceptions" : 0,
        "latestSystemExceptions" : [ ],
        "numSourceExceptions" : 0,
        "latestSourceExceptions" : [ ],
        "numWritten" : 0,
        "lastReceivedTime" : 0,
        "workerId" : "c-standalone-fw-localhost-8080"
        }
    } ]
}</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_troubleshooting"><a class="anchor" href="#_troubleshooting"></a>Troubleshooting</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you&#8217;re having issues consuming CDC events, check the source connector logs on your Pulsar function workers and the data topic schema.</p>
</div>
<div class="sect2">
<h3 id="_check_the_source_connector_logs"><a class="anchor" href="#_check_the_source_connector_logs"></a>Check the source connector logs</h3>
<div class="paragraph">
<p>Check the source connector logs on your Pulsar function workers. The name of the logs depends on the connectors' name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cat logs/functions/public/default/cassandra-source-ks1-table1/cassandra-source-ks1-table1-0.log</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_check_the_data_topic_schema"><a class="anchor" href="#_check_the_data_topic_schema"></a>Check the data topic schema</h3>
<div class="paragraph">
<p>Check the <a href="https://pulsar.apache.org/docs/en/schema-manage/">Pulsar schema</a> to ensure the clean topic matches your CQL table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bin/pulsar-admin schemas get "persistent://public/default/data-ks1.table1"
{
  "version": 0,
  "schemaInfo": {
    "name": "data-ks1.table1",
    "schema": {
      "key": {
        "name": "root",
        "schema": {
          "type": "record",
          "name": "root",
          "namespace": "ks1",
          "doc": "",
          "fields": [
            {
              "name": "key",
              "type": "string"
            }
          ]
        },
        "type": "AVRO",
        "properties": {}
      },
      "value": {
        "name": "root",
        "schema": {
          "type": "record",
          "name": "root",
          "namespace": "ks1",
          "doc": "",
          "fields": [
            {
              "name": "c1",
              "type": [
                "null",
                "string"
              ]
            }
          ]
        },
        "type": "AVRO",
        "properties": {}
      }
    },
    "type": "KEY_VALUE",
    "properties": {
      "key.schema.name": "root",
      "key.schema.properties": "{}",
      "key.schema.type": "AVRO",
      "kv.encoding.type": "SEPARATED",
      "value.schema.name": "root",
      "value.schema.properties": "{}",
      "value.schema.type": "AVRO"
    }
  }
}</pre>
</div>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main></div>
<footer class="footer">
  <div class="footer-row">
    <div class="footer__notice align-items-center row">
      <div class="order-1 order-lg-0 col-lg col-12">
        <p class="small mb-0">
          © 2021 DataStax |
          <a href="https://www.datastax.com/legal/datastax-website-privacy-policy">Privacy Policy</a> |
          <a href="https://www.datastax.com/legal/datastax-website-terms-use">Terms of Use</a>
              <!-- UNCOMMENT IF USING ONETRUST FOR COOKIES
                <span><a href="#" id="ot-sdk-btn" class="ot-sdk-show-settings">Do Not Sell My Personal Information</a></span>
              -->
        </p>
      </div>
    <div class="text-center text-lg-left mb-5 mb-lg-0 col-lg-auto col-12">
        <a class="ml-1" href="https://www.facebook.com/datastax" target="_blank" rel="noreferrer"><img
            src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTMyIDBIMHYzMS42NWgxNy4wOTVWMTkuNDM2aC00LjE4MlYxNC42Mmg0LjE2di0zLjUxNWMwLTQuMDkzIDIuNTItNi4zMiA2LjIwOS02LjMyYTM1LjI3IDM1LjI3IDAgMDEzLjc1LjIxMnY0LjI3aC0yLjU0OWMtMi4wMDQgMC0yLjM5MS45MzgtMi4zOTEgMi4zMnYzLjA1NWg0LjhsLS42MjMgNC43OTJoLTQuMTc3VjMxLjY1SDMyVjB6IiBmaWxsPSIjMUU3MUQ0Ii8+PC9zdmc+"
            alt="Facebook logo" loading="lazy"></a>
        <a class="ml-1" href="https://twitter.com/datastax" target="_blank" rel="noreferrer"><img
            src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTMyLjAwMSAzMS42NWgtMzJWMGgzMnYzMS42NXptLTE5LjcxMi03Ljc4NWM3LjU0NCAwIDExLjY3Mi02LjE4OCAxMS42NzItMTEuNTQ1IDAtLjE3NCAwLS4zNDgtLjAwOC0uNTIyLjgtLjU3IDEuNDk2LTEuMjkgMi4wNDgtMi4xMDVhOC4zODcgOC4zODcgMCAwMS0yLjM2LjY0MSA0LjA5IDQuMDkgMCAwMDEuODA4LTIuMjQ3IDguMjExIDguMjExIDAgMDEtMi42MDguOTgxIDQuMTE2IDQuMTE2IDAgMDAtMi45OTItMS4yODJjLTIuMjY0IDAtNC4xMDQgMS44Mi00LjEwNCA0LjA2IDAgLjMxNi4wNC42MjQuMTA0LjkyNUExMS42OTIgMTEuNjkyIDAgMDE3LjM5MyA4LjUzYTQuMDI0IDQuMDI0IDAgMDAtLjU1MiAyLjA0MSA0LjA2IDQuMDYgMCAwMDEuODI0IDMuMzggNC4xODQgNC4xODQgMCAwMS0xLjg1Ni0uNTA3di4wNTVjMCAxLjk2MiAxLjQxNiAzLjYwOCAzLjI4OCAzLjk4YTQuMDQgNC4wNCAwIDAxLTEuMDguMTQzYy0uMjY0IDAtLjUyLS4wMjQtLjc2OC0uMDcyYTQuMDk3IDQuMDk3IDAgMDAzLjgzMiAyLjgxNyA4LjI4NSA4LjI4NSAwIDAxLTUuMDk2IDEuNzQxYy0uMzI4IDAtLjY1Ni0uMDE2LS45NzYtLjA1NWExMS43NjMgMTEuNzYzIDAgMDA2LjI4IDEuODEyeiIgZmlsbD0iIzFFNzFENCIvPjwvc3ZnPg=="
            alt="Twitter logo" loading="lazy"></a>
        <a class="ml-1" href="https://www.linkedin.com/company/datastax/" target="_blank" rel="noreferrer"><img
            src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTS4wMDEgMHYzMS42NWgzMlYwaC0zMnptOS40ODEgMjYuOTYyaC00Ljc0VjExLjg0aDQuNzR2MTUuMTIyek03LjExMiA5Ljc4OGEyLjcwNCAyLjcwNCAwIDAxLTIuNzI2LTIuNjk2YzAtMS41MjQgMS4yNDUtMi42OTYgMi43MjYtMi42OTYgMS41NCAwIDIuNzI2IDEuMjMgMi43MjYgMi42OTYuMDYgMS40NjUtMS4xODUgMi42OTYtMi43MjYgMi42OTZ6TTI3LjI2IDI2Ljk2MmgtNC43NHYtNy4zMjdjMC0xLjc1OC0uMDYtMy45ODUtMi40OS0zLjk4NS0yLjQ4OCAwLTIuODQ0IDEuOTM0LTIuODQ0IDMuODY4djcuNDQ0aC00Ljc0VjExLjg0aDQuNTYydjIuMDUxaC4wNmMuNjUxLTEuMTcyIDIuMTkyLTIuNDYxIDQuNTAzLTIuNDYxIDQuOCAwIDUuNjkgMy4xMDYgNS42OSA3LjIwOXY4LjMyM3oiIGZpbGw9IiMxRTcxRDQiLz48L3N2Zz4="
            alt="LinkedIn logo" loading="lazy"></a>
        <a class="ml-1" href="https://github.com/datastax/" target="_blank" rel="noreferrer"><img
            src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0zMiAwSDB2MzEuNjVoMzJWMHpNNCAxNS44MDVDNCA5LjI4NyA5LjM1OCA0IDE1Ljk2MyA0IDIyLjU3IDQgMjcuOTI3IDkuMjg3IDI4IDE1LjgwNWMwIDUuMjE1LTMuMzc2IDkuNjMyLTguMTQ3IDExLjIyNi0uNTg3LjA3Mi0uODA3LS4yOS0uODA3LS41OHYtMy4yNTljMC0xLjA4Ni0uMzY3LTEuODEtLjgwOC0yLjE3MiAyLjY0My0uMjkgNS40MzItMS4yMzIgNS40MzItNS43OTRhNC42NSA0LjY1IDAgMDAtMS4yNDgtMy4xODdsLjAyMy0uMDg1YTQuNDQgNC40NCAwIDAwLS4xNy0zLjAzcy0xLjAyNy0uMjg5LTMuMzAyIDEuMjMyYTEzLjY4MSAxMy42ODEgMCAwMC0zLjAxLS4zNjJjLTEuMDI3IDAtMi4wNTUuMDcyLTMuMDA5LjM2Mi0yLjI3NS0xLjUyLTMuMzAzLTEuMjMxLTMuMzAzLTEuMjMxLS42NDggMS41NjQtLjIzNSAyLjc4LS4xNSAzLjAyOSAwIC4wMDQuMDAyLjAwOS4wMDQuMDEzLS44MDguODY5LTEuMjQ4IDEuODgzLTEuMjQ4IDMuMTg2IDAgNC41NjMgMi43ODkgNS41NzcgNS40MzEgNS44NjctLjI5My4yOS0uNjYuNzk2LS43MzQgMS41OTMtLjY2LjI5LTIuMzQ5Ljc5Ny0zLjQ1LTEuMDE0IDAgMC0uNjYtMS4xNTktMS44MzQtMS4yMzEgMCAwLTEuMTc1IDAtLjA3NC43MjQgMCAwIC44MDguMzYyIDEuMzIxIDEuNzM4IDAgMCAuNzM0IDIuMzE4IDQuMDM3IDEuNTkzdjIuMDI4YzAgLjI5LS4yMi42NTItLjgwNy41OEM3LjQ1IDI1LjQzNyA0IDIxLjAyIDQgMTUuODA1eiIgZmlsbD0iIzFFNzFENCIvPjwvc3ZnPg=="
            alt="GitHub logo" loading="lazy"></a>
    </div>
   </div>
  </div>
</footer>
<script src="../../assets/js/site.js"></script>
<script async src="../../assets/js/vendor/highlight.js"></script>
  </body>
</html>
